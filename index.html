<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°˜ì§ ë°˜ì§ ìš°ì£¼ë¹„í–‰</title> <!-- ê²Œì„ ì œëª© ë³€ê²½ -->
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN ë¡œë“œ (ì‚¬ìš´ë“œ íš¨ê³¼ìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Firebase SDK ë¡œë“œ (ì ìˆ˜ ë­í‚¹ìš©) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ì „ì—­ ë³€ìˆ˜ ì„¤ì • (Canvas í™˜ê²½ì—ì„œ ì œê³µë˜ëŠ” ê°’ ì‚¬ìš©)
        // __app_id, __firebase_config, __initial_auth_tokenì€ Canvas ëŸ°íƒ€ì„ì—ì„œ ìë™ìœ¼ë¡œ ì£¼ì…ë©ë‹ˆë‹¤.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null; // ì‚¬ìš©ì ID

        // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Firebase authenticated. User ID:", userId);
                // ì¸ì¦ ì™„ë£Œ í›„ ì ìˆ˜ ë¡œë“œ ì‹œì‘
                window.loadScores(); // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œëœ í•¨ìˆ˜ í˜¸ì¶œ
            } else {
                // ì¸ì¦ í† í°ì´ ì—†ìœ¼ë©´ ìµëª…ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œë„
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                }
            }
        });

        // ì „ì—­ ìŠ¤ì½”í”„ì— Firebase ê´€ë ¨ ê°ì²´ ë…¸ì¶œ (ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
        window.firebaseApp = app;
        window.firestoreDb = db;
        window.firebaseAuth = auth;
        window.getUserId = () => userId; // userIdë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜

        // ê²Œì„ ì ìˆ˜ë¥¼ Firestoreì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
        window.saveGameScore = async (score, grade) => {
            if (!userId) {
                console.warn("User not authenticated. Cannot save score.");
                return;
            }
            try {
                // Firestore ë³´ì•ˆ ê·œì¹™ì— ë”°ë¼ public ë°ì´í„° ê²½ë¡œ ì‚¬ìš©
                const scoresCollectionRef = collection(db, `artifacts/${appId}/public/data/gameScores`);
                await addDoc(scoresCollectionRef, {
                    userId: userId,
                    score: score,
                    grade: grade,
                    timestamp: Date.now()
                });
                console.log("Score saved successfully!");
            } catch (e) {
                console.error("Error adding document to Firestore: ", e);
            }
        };

        // Firestoreì—ì„œ ì ìˆ˜ë¥¼ ë¡œë“œí•˜ì—¬ ë­í‚¹ ë³´ë“œë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        window.loadScores = () => {
            if (!db) {
                console.warn("Firestore is not initialized. Retrying loadScores in 1 second.");
                setTimeout(window.loadScores, 1000); // 1ì´ˆ í›„ ì¬ì‹œë„
                return;
            }
            // Firestore ë³´ì•ˆ ê·œì¹™ì— ë”°ë¼ public ë°ì´í„° ê²½ë¡œ ì‚¬ìš©
            const scoresCollectionRef = collection(db, `artifacts/${appId}/public/data/gameScores`);
            // orderByëŠ” ì¸ë±ìŠ¤ê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
            const q = query(scoresCollectionRef, limit(10)); // ìƒìœ„ 10ê°œë§Œ ê°€ì ¸ì˜´

            onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    scores.push(doc.data());
                });
                // ì ìˆ˜ë¥¼ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì •ë ¬)
                scores.sort((a, b) => b.score - a.score);
                updateLeaderboard(scores);
            }, (error) => {
                console.error("Error fetching scores from Firestore: ", error);
            });
        };

        // ë­í‚¹ ë³´ë“œ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLeaderboard(scores) {
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return;

            leaderboardList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
            scores.forEach((data, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-center py-1 px-2 rounded-md';
                if (index === 0) listItem.classList.add('bg-yellow-700', 'text-yellow-100'); // 1ë“± ê°•ì¡°
                else if (index < 3) listItem.classList.add('bg-gray-700', 'text-gray-100'); // 2,3ë“± ê°•ì¡°
                else listItem.classList.add('text-gray-200');

                // ì‚¬ìš©ì ID ì¶•ì•½ ë° í˜„ì¬ ì‚¬ìš©ì ê°•ì¡°
                const displayName = data.userId ? data.userId.substring(0, 8) + '...' : 'Unknown';
                if (window.getUserId() && data.userId === window.getUserId()) {
                    listItem.classList.add('font-bold', 'text-blue-300'); // í˜„ì¬ ì‚¬ìš©ì ê°•ì¡°
                }

                listItem.innerHTML = `
                    <span>${index + 1}. ${displayName}</span>
                    <span>${data.score}ì  (${data.grade})</span>
                `;
                leaderboardList.appendChild(listItem);
            });
            // í˜„ì¬ ì‚¬ìš©ì ID í‘œì‹œ
            const currentUserIdDisplay = document.getElementById('currentUserId');
            if (currentUserIdDisplay && window.getUserId()) {
                currentUserIdDisplay.textContent = `ë‚´ ID: ${window.getUserId()}`;
            }
        }
    </script>
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* ì–´ë‘ìš´ ë°°ê²½ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ë°” ë°©ì§€ */
            gap: 20px; /* ê²Œì„ ì»¨í…Œì´ë„ˆì™€ ë­í‚¹ ë³´ë“œ ì‚¬ì´ ê°„ê²© */
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .game-container {
            position: relative;
            width: 600px; /* ê²Œì„ ì˜ì—­ì˜ ë„ˆë¹„ */
            height: 800px; /* ê²Œì„ ì˜ì—­ì˜ ë†’ì´ */
            background-color: #2d3748; /* íŠ¸ë™ ë°°ê²½ìƒ‰ */
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden; /* ìš”ì†Œë“¤ì´ ì»¨í…Œì´ë„ˆ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ */
            border: 5px solid #4a5568;
            display: flex; /* íŠ¸ë™ì„ ìœ„í•œ flexbox */
        }

        /* íŠ¸ë™ ìŠ¤íƒ€ì¼ */
        .track {
            flex: 1; /* ê° íŠ¸ë™ì´ ë™ì¼í•œ ë„ˆë¹„ë¥¼ ê°€ì§€ë„ë¡ */
            border-right: 1px dashed rgba(255, 255, 255, 0.2); /* íŠ¸ë™ êµ¬ë¶„ì„  */
            box-sizing: border-box;
            position: relative; /* ìì‹ ìš”ì†Œì˜ absolute ìœ„ì¹˜ë¥¼ ìœ„í•´ */
        }

        .track:last-child {
            border-right: none; /* ë§ˆì§€ë§‰ íŠ¸ë™ì€ êµ¬ë¶„ì„  ì—†ìŒ */
        }

        /* í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        .player {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: #63b3ed; /* í”Œë ˆì´ì–´ ìƒ‰ìƒ (í•˜ëŠ˜ìƒ‰) */
            border-radius: 10px;
            bottom: 100px; /* í™”ë©´ í•˜ë‹¨ì—ì„œ ì¡°ê¸ˆ ìœ„ë¡œ */
            transition: left 0.15s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ ì¢Œìš° ì´ë™ */
            box-shadow: 0 0 15px rgba(99, 179, 237, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 25px;
            color: white;
            z-index: 10; /* í”Œë ˆì´ì–´ê°€ ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— ì˜¤ë„ë¡ */
        }

        /* ì¥ì• ë¬¼ ìŠ¤íƒ€ì¼ */
        .obstacle {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: #e53e3e; /* ì¥ì• ë¬¼ ìƒ‰ìƒ (ë¹¨ê°„ìƒ‰) */
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(229, 62, 62, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 35px;
            color: white;
            font-weight: bold;
            z-index: 5;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out; /* íŒŒê´´ ì• ë‹ˆë©”ì´ì…˜ìš© */
        }

        /* ì¥ì• ë¬¼ íŒŒê´´ íš¨ê³¼ */
        .obstacle.destroyed {
            transform: scale(0.5);
            opacity: 0;
        }

        /* ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .item {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%; /* ì ¤ë¦¬ ëª¨ì–‘ */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
            z-index: 5;
        }

        /* ì ìˆ˜ ì•„ì´í…œ (ì ¤ë¦¬) */
        .item.score {
            background-color: #f6ad55; /* ì£¼í™©ìƒ‰ ì ¤ë¦¬ */
            box-shadow: 0 0 10px rgba(246, 173, 85, 0.7);
        }

        /* ìë ¥ ì•„ì´í…œ */
        .item.magnet {
            background-color: #48bb78; /* ì´ˆë¡ìƒ‰ ìì„ */
            box-shadow: 0 0 10px rgba(72, 187, 120, 0.7);
        }

        /* BONUS ê¸€ì ì•„ì´í…œ */
        .item.bonus {
            background-color: #805ad5; /* ë³´ë¼ìƒ‰ ê¸€ì */
            border-radius: 5px; /* ì‚¬ê°í˜• ëª¨ì–‘ */
            box-shadow: 0 0 10px rgba(128, 90, 213, 0.7);
            font-size: 20px;
        }

        /* ì‹œê°„ ì¦ê°€ ì•„ì´í…œ */
        .item.time-increase {
            background-color: #a0aec0; /* íšŒìƒ‰ ì‹œê³„ */
            box-shadow: 0 0 10px rgba(160, 174, 192, 0.7);
            font-size: 24px;
        }

        /* ë¬´ì§€ê°œ ì ìˆ˜ ì•„ì´í…œ (í”¼ë²„ ëª¨ë“œìš©) */
        .item.rainbow-score {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            font-size: 30px;
            animation: rainbowGlow 1.5s infinite alternate;
        }

        @keyframes rainbowGlow {
            from { box-shadow: 0 0 10px rgba(255, 255, 255, 0.8); }
            to { box-shadow: 0 0 30px rgba(255, 255, 255, 1); }
        }


        /* UI ì •ë³´ íŒ¨ë„ */
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            z-index: 20;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 8px 12px;
            border-radius: 8px;
            white-space: nowrap; /* ê¸€ìë“¤ì´ ì¤„ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ */
        }

        .info-panel span {
            margin-right: 15px;
        }

        /* BONUS ê¸€ì ì»¨í…Œì´ë„ˆ */
        #bonusLettersContainer {
            display: flex;
            align-items: center;
            gap: 5px; /* ê¸€ì ì‚¬ì´ ê°„ê²© */
        }

        /* ê°œë³„ BONUS ê¸€ì ìŠ¤íƒ€ì¼ */
        #bonusLettersContainer .bonus-letter {
            font-size: 1.1rem;
            font-weight: bold;
            color: #a0aec0; /* ê¸°ë³¸ íšŒìƒ‰ */
            transition: color 0.2s ease-in-out, text-shadow 0.2s ease-in-out;
        }

        /* íšë“í•œ BONUS ê¸€ì ìŠ¤íƒ€ì¼ */
        #bonusLettersContainer .bonus-letter.collected {
            color: #fbd38d; /* ë…¸ë€ìƒ‰ìœ¼ë¡œ ë¹›ë‚˜ëŠ” íš¨ê³¼ */
            text-shadow: 0 0 8px #fbd38d, 0 0 15px #fbd38d;
        }


        /* ê²Œì„ ì˜¤ë²„ ë©”ì‹œì§€ */
        .game-over-message {
            position: absolute;
            top: 40%; /* ìœ„ì¹˜ ì¡°ì • */
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.5rem;
            font-weight: bold;
            color: #e53e3e; /* ë¹¨ê°„ìƒ‰ */
            text-shadow: 0 0 20px rgba(229, 62, 62, 0.8);
            z-index: 100;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            animation: pulse 1.5s infinite alternate; /* ê¹œë¹¡ì´ëŠ” íš¨ê³¼ */
            text-align: center; /* í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

        /* ë“±ê¸‰ í‘œì‹œ */
        .grade-display {
            font-size: 2.5rem; /* ë“±ê¸‰ ê¸€ì í¬ê¸° */
            margin-top: 10px; /* ê²Œì„ ì˜¤ë²„ ë©”ì‹œì§€ì™€ì˜ ê°„ê²© */
            color: #fbd38d; /* ë“±ê¸‰ ìƒ‰ìƒ (ë…¸ë€ìƒ‰) */
            text-shadow: 0 0 15px rgba(251, 211, 141, 0.8);
        }


        /* ê¹œë¹¡ì´ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse {
            from { opacity: 0.7; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
        }

        /* í”¼ë²„ íƒ€ì„ íš¨ê³¼ */
        .fever-effect {
            animation: feverGlow 0.5s infinite alternate;
            box-shadow: 0 0 30px #fbd38d, 0 0 40px #fbd38d, 0 0 50px #fbd38d;
        }

        @keyframes feverGlow {
            from { box-shadow: 0 0 30px #fbd38d, 0 0 40px #fbd38d, 0 0 50px #fbd38d; }
            to { box-shadow: 0 0 20px #fbd38d, 0 0 30px #fbd38d, 0 0 40px #fbd38d; }
        }

        /* ìë ¥ íš¨ê³¼ ì‹œ ì•„ì´í…œ ëŒì–´ë‹¹ê¸°ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        .attracted {
            transition: transform 0.2s ease-out;
        }

        /* ì‹œì‘ ë²„íŠ¼ ë° ì¬ì‹œì‘ ë²„íŠ¼ */
        .start-button, .restart-button {
            position: absolute;
            top: 60%; /* ìœ„ì¹˜ ì¡°ì • */
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            background-color: #48bb78;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 101;
        }

        .start-button:hover, .restart-button:hover {
            background-color: #38a169;
            transform: translate(-50%, -50%) scale(1.05);
        }

        /* ë­í‚¹ ë³´ë“œ ìŠ¤íƒ€ì¼ */
        .leaderboard-container {
            width: 300px; /* ë­í‚¹ ë³´ë“œ ë„ˆë¹„ */
            height: 800px; /* ê²Œì„ ì»¨í…Œì´ë„ˆì™€ ë™ì¼í•œ ë†’ì´ */
            background-color: #2d3748;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            border: 5px solid #4a5568;
            padding: 20px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .leaderboard-container h2 {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #fbd38d;
        }

        .leaderboard-container ul {
            list-style: none;
            padding: 0;
            width: 100%;
        }

        .leaderboard-container li {
            background-color: rgba(0, 0, 0, 0.3);
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 1rem;
        }

        .current-user-id {
            margin-top: auto; /* í•˜ë‹¨ì— ë°°ì¹˜ */
            font-size: 0.9rem;
            color: #a0aec0; /* íšŒìƒ‰ í…ìŠ¤íŠ¸ */
            text-align: center;
            width: 100%;
            padding-top: 10px;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <div class="info-panel">
            <span>ì ìˆ˜: <span id="score">0</span></span>
            <span>ì²´ë ¥: <span id="health">3</span></span>
            <span>ì½¤ë³´: <span id="combo">0</span></span>
            <span>ì‹œê°„: <span id="time">60</span>s</span>
            <div id="bonusLettersContainer" class="ml-auto"></div> <!-- BONUS ê¸€ì ì»¨í…Œì´ë„ˆ -->
        </div>
        <div class="track"></div>
        <div class="track"></div>
        <div class="track"></div>
        <div class="player" id="player">ğŸš€</div>
        <div class="game-over-message" id="gameOverMessage">
            GAME OVER
            <div id="finalScoreDisplay" class="grade-display"></div>
            <div id="gradeDisplay" class="grade-display"></div>
        </div>
        <button class="start-button" id="startButton">ê²Œì„ ì‹œì‘</button>
        <button class="restart-button" id="restartButton" style="display: none;">ë‹¤ì‹œ ì‹œì‘</button>
    </div>

    <!-- ë­í‚¹ ë³´ë“œ ì»¨í…Œì´ë„ˆ -->
    <div class="leaderboard-container">
        <h2>ğŸ† ìµœê³  ì ìˆ˜ ë­í‚¹</h2>
        <ul id="leaderboardList">
            <!-- ë­í‚¹ ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
            <li>ë­í‚¹ ë¡œë”© ì¤‘...</li>
        </ul>
        <div id="currentUserId" class="current-user-id">ë‚´ ID: ë¡œë”© ì¤‘...</div>
    </div>

    <!-- ë°°ê²½ ìŒì•… í”Œë ˆì´ì–´ -->
    <audio id="backgroundMusic" loop volume="0.3">
        <!-- Royalty Free Game Music (Replace with your preferred URL) -->
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        // ê²Œì„ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const gameContainer = document.getElementById('gameContainer');
        const player = document.getElementById('player');
        const scoreDisplay = document.getElementById('score');
        const healthDisplay = document.getElementById('health');
        const comboDisplay = document.getElementById('combo');
        const timeDisplay = document.getElementById('time'); // ì‹œê°„ í‘œì‹œ
        const bonusLettersContainer = document.getElementById('bonusLettersContainer'); // BONUS ê¸€ì ì»¨í…Œì´ë„ˆ
        const gameOverMessage = document.getElementById('gameOverMessage');
        const finalScoreDisplay = document.getElementById('finalScoreDisplay'); // ìµœì¢… ì ìˆ˜ í‘œì‹œ
        const gradeDisplay = document.getElementById('gradeDisplay'); // ë“±ê¸‰ í‘œì‹œ
        const startButton = document.getElementById('startButton');
        const restartButton = document.getElementById('restartButton');

        // ë°°ê²½ ìŒì•… ìš”ì†Œ
        const backgroundMusic = document.getElementById('backgroundMusic');

        // ğŸ¶ ì‚¬ìš´ë“œ íš¨ê³¼ (Tone.js)
        let itemCollectSynth;
        let obstacleDestroySynth;

        // ê²Œì„ ì„¤ì • ë³€ìˆ˜
        let LANE_WIDTH; // gameContainer.offsetWidthì— ë”°ë¼ ë™ì ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.
        const PLAYER_SIZE = 50;
        const OBSTACLE_SIZE = 60;
        const ITEM_SIZE = 40;
        const PLAYER_BOTTOM_OFFSET = 100;

        let currentLane = 1;
        let score = 0;
        let health = 3;
        let combo = 0;
        const COMBO_RESET_ON_MISS = true; // ì½¤ë³´ê°€ ì•„ì´í…œ ë†“ì¹  ë•Œë§Œ ì´ˆê¸°í™”ë˜ë„ë¡

        let obstacles = [];
        let items = [];

        let initialGameSpeed = 11; // ì´ˆê¸° ê²Œì„ ì†ë„ (ìˆ˜ì •ë¨: 10 -> 11)
        let gameSpeed = initialGameSpeed;
        const SPEED_INCREASE_RATE = 0.005; // ê²Œì„ ì§„í–‰ì— ë”°ë¥¸ ì†ë„ ì¦ê°€ìœ¨ (ìˆ˜ì •ë¨: 0.004 -> 0.005)
        const SPEED_DECREASE_ON_HIT = 1.5;
        const MIN_GAME_SPEED = 2;

        let itemSpawnInterval = 400; // ì•„ì´í…œ/ì¥ì• ë¬¼ ìƒì„± ê°„ê²© (ms, ìˆ˜ì •ë¨: 450 -> 400)
        let lastSpawnTime = 0;

        let isGameOver = false;
        let isGameRunning = false;
        let animationFrameId;

        let sessionCollectedBonusLetters = new Set(); // í˜„ì¬ ê²Œì„ ì„¸ì…˜ì—ì„œ íšë“í•œ BONUS ê¸€ì
        const ALL_BONUS_LETTERS = ['B', 'O', 'N', 'U', 'S'];
        let isFeverTime = false;
        let feverTimeDuration = 5000; // í”¼ë²„ íƒ€ì„ ì§€ì† ì‹œê°„ 5ì´ˆ
        let feverTimeTimeoutId;

        let isMagnetActive = false;
        let magnetDuration = 5000; // ìë ¥ ì•„ì´í…œ ì§€ì† ì‹œê°„ 5ì´ˆ (í”¼ë²„ ëª¨ë“œì™€ ë™ì¼í•˜ê²Œ)
        let magnetTimeoutId;
        const MAGNET_RANGE_NORMAL = 150; // ì¼ë°˜ ìë ¥ ì•„ì´í…œì˜ ë²”ìœ„
        const MAGNET_RANGE_FEVER = 350; // í”¼ë²„ íƒ€ì„ ì‹œ ìë ¥ ì•„ì´í…œì˜ ë²”ìœ„ (ìˆ˜ì •ë¨: 150 -> 350)
        let currentMagnetRange = MAGNET_RANGE_NORMAL; // í˜„ì¬ ì ìš©ë˜ëŠ” ìì„ ë²”ìœ„

        let gameStartTime = 0;
        let gameCurrentTime = 0; // ê²Œì„ ë‚´ í˜„ì¬ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
        const GAME_DURATION = 60 * 1000; // ê²Œì„ ì œí•œ ì‹œê°„ 1ë¶„ (ms)
        const TIME_INCREASE_AMOUNT = 10 * 1000; // ì‹œê°„ ì¦ê°€ ì•„ì´í…œ íšë“ ì‹œ 10ì´ˆ ì¦ê°€

        const OBSTACLE_EMOJIS = ['ğŸš§', 'ğŸš¨', 'ğŸ›‘', ' ', 'âŒ', 'ğŸ’£', 'ğŸ’¥', 'ğŸ”¥', 'â˜„ï¸', 'ğŸ›°ï¸']; // ë‹¤ì–‘í•œ ì¥ì• ë¬¼ ì´ëª¨ì§€ ì¶”ê°€

        // Tone.js ì‚¬ìš´ë“œ ì´ˆê¸°í™”
        async function initializeSounds() {
            // ì›¹ ì˜¤ë””ì˜¤ APIëŠ” ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ì— í™œì„±í™”ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
            // Tone.start()ëŠ” AudioContextë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤.
            document.documentElement.addEventListener('mousedown', () => {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                    console.log("AudioContext started");
                }
            });
            document.documentElement.addEventListener('keydown', () => {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                    console.log("AudioContext started");
                }
            });

            itemCollectSynth = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.005,
                    decay: 0.1,
                    sustain: 0.05,
                    release: 0.1
                }
            }).toDestination();

            obstacleDestroySynth = new Tone.Synth({
                oscillator: { type: "triangle" },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.01,
                    release: 0.3
                }
            }).toDestination();
        }

        // í”Œë ˆì´ì–´ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
        function initializePlayerPosition() {
            LANE_WIDTH = gameContainer.offsetWidth / 3;
            player.style.left = `${currentLane * LANE_WIDTH + (LANE_WIDTH / 2) - (PLAYER_SIZE / 2)}px`;
            player.style.bottom = `${PLAYER_BOTTOM_OFFSET}px`;
        }

        // ê²Œì„ ì´ˆê¸°í™”
        function initializeGame() {
            score = 0;
            health = 3;
            combo = 0;
            currentLane = 1;
            obstacles = [];
            items = [];
            sessionCollectedBonusLetters.clear(); // ê²Œì„ ì‹œì‘ ì‹œ BONUS ê¸€ì ì´ˆê¸°í™”
            isGameOver = false;
            isGameRunning = false;
            gameSpeed = initialGameSpeed; // ì´ˆê¸° ì†ë„ë¡œ ì¬ì„¤ì •
            itemSpawnInterval = 400; // ì´ˆê¸° ìƒì„± ê°„ê²©ìœ¼ë¡œ ì¬ì„¤ì •
            lastSpawnTime = 0;
            isFeverTime = false;
            isMagnetActive = false;
            currentMagnetRange = MAGNET_RANGE_NORMAL; // ìì„ ë²”ìœ„ ì´ˆê¸°í™”
            gameStartTime = 0;
            gameCurrentTime = GAME_DURATION; // ê²Œì„ ë‚´ í˜„ì¬ ì‹œê°„ ì´ˆê¸°í™”

            scoreDisplay.textContent = score;
            healthDisplay.textContent = health;
            comboDisplay.textContent = combo;
            timeDisplay.textContent = GAME_DURATION / 1000;
            updateBonusLettersDisplay(); // BONUS ê¸€ì UI ì´ˆê¸°í™”
            gameOverMessage.style.display = 'none';
            player.classList.remove('fever-effect');
            restartButton.style.display = 'none';
            startButton.style.display = 'block';

            document.querySelectorAll('.obstacle, .item').forEach(el => el.remove());

            initializePlayerPosition();
            backgroundMusic.pause();
            backgroundMusic.currentTime = 0; // ìŒì•… ì²˜ìŒìœ¼ë¡œ ë˜ê°ê¸°
            backgroundMusic.playbackRate = 1.0; // ìŒì•… ì¬ìƒ ì†ë„ ì´ˆê¸°í™”
        }

        // ê²Œì„ ì‹œì‘
        function startGame() {
            if (isGameRunning) return;

            isGameRunning = true;
            startButton.style.display = 'none';
            restartButton.style.display = 'none';
            gameOverMessage.style.display = 'none';
            gameStartTime = performance.now();
            // gameCurrentTimeì€ initializeGameì—ì„œ ì´ë¯¸ ì„¤ì •ë¨

            animationFrameId = requestAnimationFrame(gameLoop);
            lastSpawnTime = performance.now();

            // ë°°ê²½ ìŒì•… ì¬ìƒ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„)
            backgroundMusic.play().catch(error => {
                console.warn("ë°°ê²½ ìŒì•… ìë™ ì¬ìƒ ì‹¤íŒ¨:", error);
            });
        }

        // ê²Œì„ ë£¨í”„
        function gameLoop(currentTime) {
            if (isGameOver || !isGameRunning) {
                return;
            }

            const deltaTime = currentTime - (gameLoop.lastTime || currentTime);
            gameLoop.lastTime = currentTime;

            gameCurrentTime -= deltaTime; // ë‚¨ì€ ì‹œê°„ ê°ì†Œ
            const remainingTimeSeconds = Math.max(0, Math.ceil(gameCurrentTime / 1000));
            timeDisplay.textContent = remainingTimeSeconds;

            if (remainingTimeSeconds <= 0) {
                gameOver();
                return;
            }

            gameSpeed += SPEED_INCREASE_RATE * (deltaTime / 1000); // deltaTimeì„ ì‚¬ìš©í•˜ì—¬ í”„ë ˆì„ ì†ë„ì— ë…ë¦½ì ì¸ ì†ë„ ì¦ê°€

            // ìŒì•… ì¬ìƒ ì†ë„ ì¡°ì ˆ
            const basePlaybackRate = 1.0;
            const speedFactor = (gameSpeed - initialGameSpeed) * 0.15; // ì†ë„ì— ë¹„ë¡€í•˜ì—¬ ì¦ê°€í•˜ëŠ” ë¹„ìœ¨
            backgroundMusic.playbackRate = Math.min(3.0, basePlaybackRate + speedFactor); // ìµœëŒ€ 3.0ë°°ê¹Œì§€

            // ì•„ì´í…œ ìŠ¤í° ê°„ê²©ì„ ê²Œì„ ì†ë„ì— ë”°ë¼ ì¡°ì ˆ (ë” ë¹ ë¥´ê²Œ ìŠ¤í°)
            const currentItemSpawnInterval = Math.max(150, itemSpawnInterval - (gameSpeed * 10)); // ìµœì†Œ 150ms (ìˆ˜ì •ë¨: 200 -> 150)
            if (currentTime - lastSpawnTime > currentItemSpawnInterval) {
                spawnRandomObject();
                lastSpawnTime = currentTime;
            }

            moveObjects();
            checkCollisions();

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // í”Œë ˆì´ì–´ ì¢Œìš° ì´ë™
        function movePlayer(direction) {
            if (isGameOver) return;

            const newLane = currentLane + direction;
            if (newLane >= 0 && newLane <= 2) {
                currentLane = newLane;
                player.style.left = `${currentLane * LANE_WIDTH + (LANE_WIDTH / 2) - (PLAYER_SIZE / 2)}px`;
            }
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        document.addEventListener('keydown', (e) => {
            if (!isGameRunning && e.key === ' ') {
                startGame();
                return;
            }
            if (isGameOver && e.key === 'r') {
                restartGame();
                return;
            }

            if (!isGameRunning || isGameOver) return;

            if (e.key === 'ArrowLeft') {
                movePlayer(-1);
            } else if (e.key === 'ArrowRight') {
                movePlayer(1);
            }
        });

        // ëœë¤ ê°ì²´ (ì•„ì´í…œ ë˜ëŠ” ì¥ì• ë¬¼) ìƒì„±
        function spawnRandomObject() {
            LANE_WIDTH = gameContainer.offsetWidth / 3;

            // í”¼ë²„ íƒ€ì„ ì¤‘ì—ëŠ” ëª¨ë“  íŠ¸ë™ì— ë¬´ì§€ê°œ ì ìˆ˜ ì•„ì´í…œë§Œ ìƒì„±
            if (isFeverTime) {
                for (let i = 0; i < 3; i++) { // ê° íŠ¸ë™ì— í•˜ë‚˜ì”©
                    const objectElement = document.createElement('div');
                    objectElement.classList.add('item', 'rainbow-score');
                    objectElement.textContent = 'ğŸŒˆ';
                    objectElement.dataset.type = 'rainbow-score';
                    objectElement.style.width = `${ITEM_SIZE + 10}px`;
                    objectElement.style.height = `${ITEM_SIZE + 10}px`;
                    const leftPosition = i * LANE_WIDTH + (LANE_WIDTH / 2);
                    objectElement.style.left = `${leftPosition - ((ITEM_SIZE + 10) / 2)}px`;
                    objectElement.style.top = `-100px`; // í™”ë©´ ìœ„ì—ì„œ ì‹œì‘
                    items.push(objectElement);
                    gameContainer.appendChild(objectElement);
                }
                return; // í”¼ë²„ ì¤‘ì—ëŠ” ë‹¤ë¥¸ ì•„ì´í…œ/ì¥ì• ë¬¼ ìƒì„± ì•ˆ í•¨
            }

            // ì¼ë°˜ ì•„ì´í…œ ë˜ëŠ” ì¥ì• ë¬¼ ìƒì„±
            const lane = Math.floor(Math.random() * 3);
            const objectElement = document.createElement('div');
            objectElement.style.top = `-100px`;
            const leftPosition = lane * LANE_WIDTH + (LANE_WIDTH / 2);

            const typeRoll = Math.random();
            let type;
            if (typeRoll < 0.80) { // 80% í™•ë¥ ë¡œ ì•„ì´í…œ
                type = 'item';
            } else { // 20% í™•ë¥ ë¡œ ì¥ì• ë¬¼
                type = 'obstacle';
            }

            if (type === 'obstacle') {
                objectElement.classList.add('obstacle');
                objectElement.textContent = OBSTACLE_EMOJIS[Math.floor(Math.random() * OBSTACLE_EMOJIS.length)]; // ë‹¤ì–‘í•œ ì¥ì• ë¬¼
                objectElement.dataset.isMovingHorizontally = 'true'; // ëª¨ë“  ì¥ì• ë¬¼ì´ ì¢Œìš°ë¡œ ì›€ì§ì„
                objectElement.dataset.horizontalSpeed = (Math.random() * 2 + 1).toFixed(2); // 1.0 ~ 3.0
                objectElement.dataset.horizontalDirection = Math.random() < 0.5 ? '1' : '-1';
                objectElement.style.width = `${OBSTACLE_SIZE}px`;
                objectElement.style.height = `${OBSTACLE_SIZE}px`;
                objectElement.style.left = `${leftPosition - (OBSTACLE_SIZE / 2)}px`;
                obstacles.push(objectElement);
            } else { // type === 'item'
                objectElement.classList.add('item');
                objectElement.style.width = `${ITEM_SIZE}px`;
                objectElement.style.height = `${ITEM_SIZE}px`;
                objectElement.style.left = `${leftPosition - (ITEM_SIZE / 2)}px`;

                const itemTypeRoll = Math.random();
                if (itemTypeRoll < 0.72) { // 72% for score (ìˆ˜ì •ë¨: 60% -> 72%)
                    objectElement.classList.add('score');
                    objectElement.textContent = 'â­';
                    objectElement.dataset.type = 'score';
                    objectElement.dataset.collected = 'false';
                } else if (itemTypeRoll < 0.80) { // 8% for magnet (ìˆ˜ì •ë¨: 15% -> 8%)
                    objectElement.classList.add('magnet');
                    objectElement.textContent = 'ğŸ§²';
                    objectElement.dataset.type = 'magnet';
                } else if (itemTypeRoll < 0.98) { // 18% for bonus (ìˆ˜ì •ë¨: 15% -> 18%)
                    // í˜„ì¬ ì„¸ì…˜ì—ì„œ ì•„ì§ íšë“í•˜ì§€ ì•Šì€ BONUS ê¸€ìë§Œ ìƒì„±
                    const availableLetters = ALL_BONUS_LETTERS.filter(letter => !sessionCollectedBonusLetters.has(letter));
                    if (availableLetters.length > 0) {
                        const randomLetter = availableLetters[Math.floor(Math.random() * availableLetters.length)];
                        objectElement.classList.add('bonus');
                        objectElement.textContent = randomLetter;
                        objectElement.dataset.type = 'bonus';
                        objectElement.dataset.letter = randomLetter;
                    } else {
                        // ëª¨ë“  BONUS ê¸€ìë¥¼ ëª¨ì•˜ë‹¤ë©´ ì ìˆ˜ ì•„ì´í…œìœ¼ë¡œ ëŒ€ì²´
                        objectElement.classList.add('score');
                        objectElement.textContent = 'â­';
                        objectElement.dataset.type = 'score';
                        objectElement.dataset.collected = 'false';
                    }
                } else { // 2% for time-increase (ìˆ˜ì •ë¨: 10% -> 2%)
                    objectElement.classList.add('time-increase');
                    objectElement.textContent = 'â±ï¸';
                    objectElement.dataset.type = 'time-increase';
                }
                items.push(objectElement);
            }
            gameContainer.appendChild(objectElement);
        }

        // ëª¨ë“  ê°ì²´ ì´ë™
        function moveObjects() {
            // ì¥ì• ë¬¼ ì´ë™
            obstacles.forEach((obstacle, index) => {
                let currentTop = parseFloat(obstacle.style.top);
                obstacle.style.top = `${currentTop + gameSpeed}px`;

                // ìˆ˜í‰ ì´ë™í•˜ëŠ” ì¥ì• ë¬¼ ì²˜ë¦¬
                if (obstacle.dataset.isMovingHorizontally === 'true') {
                    let currentLeft = parseFloat(obstacle.style.left);
                    let horizontalSpeed = parseFloat(obstacle.dataset.horizontalSpeed);
                    let horizontalDirection = parseInt(obstacle.dataset.horizontalDirection);

                    // ì¥ì• ë¬¼ì´ íŠ¸ë™ ì¤‘ì•™ì— ìƒì„±ë˜ë¯€ë¡œ, íŠ¸ë™ì˜ ì™¼ìª½/ì˜¤ë¥¸ìª½ ê²½ê³„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì›€ì§ì´ë„ë¡ ê³„ì‚°
                    const obstacleWidth = parseFloat(obstacle.style.width);
                    const laneIndex = Math.floor((currentLeft + obstacleWidth / 2) / LANE_WIDTH);
                    const laneLeftBoundary = laneIndex * LANE_WIDTH;
                    const laneRightBoundary = (laneIndex + 1) * LANE_WIDTH - obstacleWidth;

                    let newLeft = currentLeft + horizontalSpeed * horizontalDirection;

                    // íŠ¸ë™ ê²½ê³„ì— ë„ë‹¬í•˜ë©´ ë°©í–¥ ë°˜ì „
                    if (newLeft <= laneLeftBoundary || newLeft >= laneRightBoundary) {
                        horizontalDirection *= -1;
                        obstacle.dataset.horizontalDirection = horizontalDirection;
                        newLeft = currentLeft + horizontalSpeed * horizontalDirection; // ë°©í–¥ ë°”ê¾¼ í›„ ë‹¤ì‹œ ê³„ì‚°
                    }
                    obstacle.style.left = `${newLeft}px`;
                }


                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°„ ì¥ì• ë¬¼ ì œê±°
                if (currentTop > gameContainer.offsetHeight) {
                    obstacle.remove();
                    obstacles.splice(index, 1);
                }
            });

            // ì•„ì´í…œ ì´ë™
            items.forEach((item, index) => {
                let currentTop = parseFloat(item.style.top);

                // ìë ¥ ì•„ì´í…œ í™œì„±í™” ì‹œ ëŒì–´ë‹¹ê¸°ê¸°
                if (isMagnetActive && (item.dataset.type === 'score' || item.dataset.type === 'rainbow-score' || item.dataset.type === 'magnet' || item.dataset.type === 'bonus' || item.dataset.type === 'time-increase')) {
                    const playerRect = player.getBoundingClientRect();
                    const itemRect = item.getBoundingClientRect();

                    const gameContainerRect = gameContainer.getBoundingClientRect();
                    const playerCenterX = (playerRect.left + playerRect.width / 2) - gameContainerRect.left;
                    const playerCenterY = (playerRect.top + playerRect.height / 2) - gameContainerRect.top;
                    const itemCenterX = (itemRect.left + itemRect.width / 2) - gameContainerRect.left;
                    const itemCenterY = (itemRect.top + itemRect.height / 2) - gameContainerRect.top;


                    const distanceX = playerCenterX - itemCenterX;
                    const distanceY = playerCenterY - itemCenterY;
                    const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);

                    // í˜„ì¬ ìì„ ë²”ìœ„ ì‚¬ìš©
                    if (distance < currentMagnetRange) {
                        const attractionSpeed = 10; // ìë ¥ ì†ë„ ë” ê°•í•˜ê²Œ
                        item.style.left = `${parseFloat(item.style.left) + distanceX / distance * attractionSpeed}px`;
                        item.style.top = `${currentTop + distanceY / distance * attractionSpeed + gameSpeed}px`;
                        item.classList.add('attracted');
                    } else {
                        item.style.top = `${currentTop + gameSpeed}px`;
                        item.classList.remove('attracted');
                    }
                } else {
                    item.style.top = `${currentTop + gameSpeed}px`;
                    item.classList.remove('attracted');
                }

                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°„ ì•„ì´í…œ ì œê±° ë° ì½¤ë³´ ì´ˆê¸°í™”
                if (currentTop > gameContainer.offsetHeight) {
                    if ((item.dataset.type === 'score' || item.dataset.type === 'rainbow-score') && item.dataset.collected === 'false' && COMBO_RESET_ON_MISS) {
                        combo = 0; // ì ìˆ˜ ì•„ì´í…œì„ ë†“ì¹˜ë©´ ì½¤ë³´ ì´ˆê¸°í™”
                        comboDisplay.textContent = combo;
                    }
                    item.remove();
                    items.splice(index, 1);
                }
            });
        }

        // ì¶©ëŒ ê°ì§€
        function checkCollisions() {
            const playerRect = player.getBoundingClientRect();

            // ì¥ì• ë¬¼ ì¶©ëŒ í™•ì¸
            obstacles.forEach((obstacle, index) => {
                const obstacleRect = obstacle.getBoundingClientRect();

                if (
                    playerRect.left < obstacleRect.right &&
                    playerRect.right > obstacleRect.left &&
                    playerRect.top < obstacleRect.bottom &&
                    playerRect.bottom > obstacleRect.top
                ) {
                    // ì¶©ëŒ ë°œìƒ
                    if (isFeverTime) {
                        // í”¼ë²„ íƒ€ì„ ì¤‘ì—ëŠ” ì¥ì• ë¬¼ íŒŒê´´ ì—°ì¶œ ë° ì†Œë¦¬
                        obstacle.classList.add('destroyed'); // íŒŒê´´ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì¶”ê°€
                        obstacleDestroySynth.triggerAttackRelease("C2", "8n"); // íŒŒê´´ ì†Œë¦¬
                        setTimeout(() => {
                            obstacle.remove();
                            obstacles.splice(index, 1);
                        }, 100); // ì• ë‹ˆë©”ì´ì…˜ ì§€ì† ì‹œê°„ í›„ ì œê±°
                    } else {
                        health--;
                        healthDisplay.textContent = health;
                        obstacle.remove();
                        obstacles.splice(index, 1);
                        combo = 0;
                        comboDisplay.textContent = combo;
                        gameSpeed = Math.max(MIN_GAME_SPEED, gameSpeed - SPEED_DECREASE_ON_HIT);

                        if (health <= 0) {
                            gameOver();
                        }
                    }
                }
            });

            // ì•„ì´í…œ ì¶©ëŒ í™•ì¸
            items.forEach((item, index) => {
                const itemRect = item.getBoundingClientRect();

                if (
                    playerRect.left < itemRect.right &&
                    playerRect.right > itemRect.left &&
                    playerRect.top < itemRect.bottom &&
                    playerRect.bottom > itemRect.top
                ) {
                    // ì•„ì´í…œ íšë“
                    handleItemCollection(item);
                    item.remove();
                    items.splice(index, 1);
                }
            });
        }

        // ì•„ì´í…œ íšë“ ì²˜ë¦¬
        function handleItemCollection(item) {
            const type = item.dataset.type;
            const currentTime = performance.now();

            if (type === 'score') {
                item.dataset.collected = 'true';
                score += 1000;
                combo++;
                score += combo * 100;
                lastItemCollectedTime = currentTime;
                scoreDisplay.textContent = score;
                comboDisplay.textContent = combo;
                itemCollectSynth.triggerAttackRelease("C5", "16n"); // ì•„ì´í…œ íšë“ ì†Œë¦¬
            } else if (type === 'magnet') {
                activateMagnet();
                itemCollectSynth.triggerAttackRelease("E5", "16n"); // ìë ¥ ì•„ì´í…œ íšë“ ì†Œë¦¬
            } else if (type === 'bonus') {
                const letter = item.dataset.letter;
                if (!sessionCollectedBonusLetters.has(letter)) { // í˜„ì¬ ì„¸ì…˜ì—ì„œ ì²˜ìŒ íšë“í•˜ëŠ” ê¸€ìì¸ì§€ í™•ì¸
                    sessionCollectedBonusLetters.add(letter); // ì„¸ì…˜ì— ì¶”ê°€
                    updateBonusLettersDisplay(); // BONUS ê¸€ì UI ì—…ë°ì´íŠ¸
                    itemCollectSynth.triggerAttackRelease("G5", "16n"); // ë³´ë„ˆìŠ¤ ì•„ì´í…œ íšë“ ì†Œë¦¬
                    if (sessionCollectedBonusLetters.size === ALL_BONUS_LETTERS.length) {
                        activateFeverTime();
                    }
                }
            } else if (type === 'time-increase') { // ì‹œê°„ ì¦ê°€ ì•„ì´í…œ
                gameCurrentTime += TIME_INCREASE_AMOUNT; // ë‚¨ì€ ì‹œê°„ ì¦ê°€ íš¨ê³¼
                timeDisplay.textContent = Math.ceil(gameCurrentTime / 1000);
                itemCollectSynth.triggerAttackRelease("F#5", "16n"); // ì‹œê°„ ì•„ì´í…œ íšë“ ì†Œë¦¬
            } else if (type === 'rainbow-score') { // ë¬´ì§€ê°œ ì ìˆ˜ ì•„ì´í…œ
                score += 5000; // ë” ë†’ì€ ì ìˆ˜
                scoreDisplay.textContent = score;
                itemCollectSynth.triggerAttackRelease("G6", "16n"); // ë¬´ì§€ê°œ ì•„ì´í…œ íšë“ ì†Œë¦¬ (ë” ë†’ì€ ìŒ)
            }
        }

        // BONUS ê¸€ì UI ì—…ë°ì´íŠ¸ (ê°œë³„ ê¸€ì ë¶ˆ ë“¤ì–´ì˜¤ëŠ” íš¨ê³¼)
        function updateBonusLettersDisplay() {
            bonusLettersContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
            ALL_BONUS_LETTERS.forEach(letter => {
                const span = document.createElement('span');
                span.textContent = letter;
                span.classList.add('bonus-letter'); // ê¸°ë³¸ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤
                if (sessionCollectedBonusLetters.has(letter)) { // ì„¸ì…˜ íšë“ ì—¬ë¶€ í™•ì¸
                    span.classList.add('collected'); // íšë“ ì‹œ ë¶ˆ ë“¤ì–´ì˜¤ëŠ” íš¨ê³¼ í´ë˜ìŠ¤
                }
                bonusLettersContainer.appendChild(span);
            });
        }

        // ìë ¥ ì•„ì´í…œ í™œì„±í™”
        function activateMagnet() {
            if (isMagnetActive) {
                clearTimeout(magnetTimeoutId);
            }
            isMagnetActive = true;
            currentMagnetRange = MAGNET_RANGE_NORMAL; // ì¼ë°˜ ìì„ ì•„ì´í…œ íšë“ ì‹œ ì¼ë°˜ ë²”ìœ„ ì ìš©
            magnetTimeoutId = setTimeout(() => {
                isMagnetActive = false;
            }, magnetDuration);
        }

        // í”¼ë²„ íƒ€ì„ í™œì„±í™”
        function activateFeverTime() {
            if (isFeverTime) return;

            isFeverTime = true;
            gameSpeed *= 2; // ì†ë„ 200% ì¦ê°€
            player.classList.add('fever-effect');
            isMagnetActive = true; // í”¼ë²„ ëª¨ë“œ ì‹œ ìì„ í™œì„±í™”
            currentMagnetRange = MAGNET_RANGE_FEVER; // í”¼ë²„ íƒ€ì„ ì‹œ ìì„ ë²”ìœ„ ëŒ€í­ í™•ëŒ€

            // í”¼ë²„ íƒ€ì„ ì‹œì‘ ì‹œ, BONUS ê¸€ì ë¶ˆë¹›ì´ ì„œì„œíˆ ì›ë˜ëŒ€ë¡œ ëŒì•„ì˜¤ë„ë¡
            // í”¼ë²„ íƒ€ì„ì´ ëë‚  ë•Œ collected í´ë˜ìŠ¤ë¥¼ ì œê±°í•˜ì—¬ ë¶ˆë¹›ì„ ë•ë‹ˆë‹¤.
            feverTimeTimeoutId = setTimeout(() => {
                deactivateFeverTime();
                // í”¼ë²„ íƒ€ì„ ì¢…ë£Œ ì‹œ ëª¨ë“  BONUS ê¸€ìì˜ collected í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('#bonusLettersContainer .bonus-letter').forEach(span => {
                    span.classList.remove('collected');
                });
            }, feverTimeDuration);
        }

        // í”¼ë²„ íƒ€ì„ ë¹„í™œì„±í™”
        function deactivateFeverTime() {
            isFeverTime = false;
            gameSpeed /= 2; // ì†ë„ ì›ìƒ ë³µêµ¬
            player.classList.remove('fever-effect');
            isMagnetActive = false; // í”¼ë²„ ëª¨ë“œ ì¢…ë£Œ ì‹œ ìì„ ë¹„í™œì„±í™”
            currentMagnetRange = MAGNET_RANGE_NORMAL; // ìì„ ë²”ìœ„ ì›ìƒ ë³µêµ¬
        }

        // ë“±ê¸‰ ê³„ì‚° í•¨ìˆ˜
        function calculateGrade(finalScore) {
            if (finalScore >= 100000) return 'SSS';
            else if (finalScore >= 80000) return 'SS';
            else if (finalScore >= 60000) return 'S';
            else if (finalScore >= 40000) return 'A';
            else if (finalScore >= 20000) return 'B';
            else if (finalScore >= 10000) return 'C';
            else if (finalScore >= 5000) return 'D';
            else return 'F';
        }

        // ê²Œì„ ì˜¤ë²„
        function gameOver() {
            isGameOver = true;
            isGameRunning = false;
            cancelAnimationFrame(animationFrameId);
            clearTimeout(feverTimeTimeoutId);
            clearTimeout(magnetTimeoutId);

            const finalScore = score;
            const grade = calculateGrade(finalScore);

            finalScoreDisplay.textContent = `ìµœì¢… ì ìˆ˜: ${finalScore}`;
            gradeDisplay.textContent = `ë“±ê¸‰: ${grade}`;
            gameOverMessage.style.display = 'block';
            restartButton.style.display = 'block';

            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;
            backgroundMusic.playbackRate = 1.0; // ìŒì•… ì¬ìƒ ì†ë„ ì´ˆê¸°í™”

            // ê²Œì„ ì˜¤ë²„ ì‹œ ëª¨ë“  BONUS ê¸€ì ë¶ˆë¹› ë„ê¸°
            document.querySelectorAll('#bonusLettersContainer .bonus-letter').forEach(span => {
                span.classList.remove('collected');
            });

            // ì ìˆ˜ ë­í‚¹ ì €ì¥ (window ê°ì²´ì— ë…¸ì¶œëœ í•¨ìˆ˜ ì‚¬ìš©)
            if (window.saveGameScore) {
                window.saveGameScore(finalScore, grade);
            } else {
                console.error("saveGameScore function is not available.");
            }
        }

        // ê²Œì„ ì¬ì‹œì‘
        function restartGame() {
            initializeGame();
            startGame();
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', restartGame);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = () => {
            initializeSounds(); // ì‚¬ìš´ë“œ ì´ˆê¸°í™”
            initializeGame();
            // Firebase ë¡œë”©ì´ ì™„ë£Œë˜ë©´ loadScoresê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤.
        };
    </script>
</body>
</html>
